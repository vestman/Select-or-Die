/* ===========================================================
 *
 *  Name:          selectordie.js
 *  Updated:       2014-11-30
 *  Version:       0.1.9
 *  Created by:    Per V @ Vst.mn
 *  What?:         The Select or Die JS
 *
 *  Copyright (c) 2014 Per Vestman
 *  Dual licensed under the MIT and GPL licenses.
 *
 *  To much comments in the code. Please, I know.
 *
 *  Oddny | Cogs 'n Kegs
 *
 * =========================================================== */

!function(a){"use strict";a.fn.selectOrDie=function(b){var c,d,e={customID:null,customClass:"",placeholder:null,placeholderOption:!1,prefix:null,cycle:!1,stripEmpty:!1,links:!1,linksExternal:!1,size:0,tabIndex:0,onChange:a.noop},f={},g=!1,h={initSoD:function(b){return f=a.extend({},e,b),this.each(function(){if(a(this).parent().hasClass("sod_select"))console.log("Select or Die: It looks like the SoD already exists");else{var b,c,d,e=a(this),g=e.data("custom-id")?e.data("custom-id"):f.customID,i=e.data("custom-class")?e.data("custom-class"):f.customClass,j=e.data("prefix")?e.data("prefix"):f.prefix,k=e.data("placeholder")?e.data("placeholder"):f.placeholder,l=e.data("placeholder-option")?e.data("placeholder-option"):f.placeholderOption,m=e.data("cycle")?e.data("cycle"):f.cycle,n=e.data("links")?e.data("links"):f.links,o=e.data("links-external")?e.data("links-external"):f.linksExternal,p=parseInt(e.data("size"))?e.data("size"):f.size,q=parseInt(e.data("tabindex"))?e.data("tabindex"):f.tabIndex?f.tabIndex:e.attr("tabindex")?e.attr("tabindex"):f.tabIndex,r=e.data("strip-empty")?e.data("strip-empty"):f.stripEmpty,s=e.prop("title")?e.prop("title"):null,t=e.is(":disabled")?" disabled":"",u="",v="",w=0;j&&(u='<span class="sod_prefix">'+j+"</span> "),v+=k&&!j?'<span class="sod_label sod_placeholder">'+k+"</span>":'<span class="sod_label">'+u+"</span>",b=a("<span/>",{id:g,"class":"sod_select "+i+t,title:s,tabindex:q,html:v,"data-cycle":m,"data-links":n,"data-links-external":o,"data-placeholder":k,"data-placeholder-option":l,"data-prefix":j,"data-filter":""}).insertAfter(this),h.isTouch()&&b.addClass("touch"),c=a("<span/>",{"class":"sod_list_wrapper"}).appendTo(b),d=a("<span/>",{"class":"sod_list"}).appendTo(c),a("option, optgroup",e).each(function(c){var e=a(this);r&&!a.trim(e.text())?e.remove():0===c&&l&&!u?h.populateSoD(e,d,b,!0):h.populateSoD(e,d,b,!1)}),p&&(c.show(),a(".sod_option:lt("+p+")",d).each(function(){w+=a(this).outerHeight()}),c.removeAttr("style"),d.css({"max-height":w})),e.appendTo(b),b.on("focusin",h.focusSod).on("click",h.triggerSod).on("click",".sod_option",h.optionClick).on("mousemove",".sod_option",h.optionHover).on("keydown",h.keyboardUse),e.on("change",h.selectChange),a(document).on("click","label[for='"+e.attr("id")+"']",function(a){a.preventDefault(),b.focus()})}})},populateSoD:function(b,c,d,e){var f=d.data("placeholder"),g=d.data("placeholder-option"),h=d.data("prefix"),i=d.find(".sod_label"),j=b.parent(),k=b.text(),l=b.val(),m=b.data("custom-id")?b.data("custom-id"):null,n=b.data("custom-class")?b.data("custom-class"):"",o=b.is(":disabled")?" disabled ":"",p=b.is(":selected")?" selected active ":"",q=b.data("link")?" link ":"",r=b.data("link-external")?" linkexternal":"",s=b.prop("label");b.is("option")?(a("<span/>",{"class":"sod_option "+n+o+p+q+r,id:m,title:k,html:k,"data-value":l}).appendTo(c),e&&!h?(d.data("label",k),d.data("placeholder",k),b.prop("disabled",!0),c.find(".sod_option:last").addClass("is-placeholder disabled"),p&&i.addClass("sod_placeholder")):p&&f&&!g&&!h?d.data("label",f):p&&d.data("label",k),(p&&!f||p&&g||p&&h)&&i.append(k),j.is("optgroup")&&(c.find(".sod_option:last").addClass("groupchild"),j.is(":disabled")&&c.find(".sod_option:last").addClass("disabled"))):a("<span/>",{"class":"sod_option optgroup "+o,title:s,html:s,"data-label":s}).appendTo(c)},focusSod:function(){var b=a(this);b.hasClass("disabled")?h.blurSod(b):(h.blurSod(a(".sod_select.focus").not(b)),b.addClass("focus"),a("html").on("click.sodBlur",function(){h.blurSod(b)}))},triggerSod:function(b){b.stopPropagation();var c=a(this),e=c.find(".sod_list"),f=c.data("placeholder"),g=c.find(".active"),i=c.find(".selected"),j=c.data("touch_open");c.hasClass("disabled")||c.hasClass("open")||c.hasClass("touch")?!j&&c.hasClass("touch")?(c.data("touch_open",!0),f&&!c.data("prefix")&&c.find(".sod_label").addClass("sod_placeholder").html(f)):j&&c.hasClass("touch")?c.data("touch_open",!1):(clearTimeout(d),c.removeClass("open"),f&&(c.find(".sod_label").get(0).lastChild.nodeValue=g.text())):(c.addClass("open"),f&&!c.data("prefix")&&c.find(".sod_label").addClass("sod_placeholder").html(f),h.listScroll(e,i),h.checkViewport(c,e))},keyboardUse:function(b){var d,e,f,i=a(this),j=i.find(".sod_list"),k=i.find(".sod_option"),l=i.find(".sod_label"),m=i.data("cycle"),n=k.filter(".active");return b.which>36&&b.which<41?(37===b.which||38===b.which?(e=n.prevAll(":not('.disabled, .optgroup')").first(),f=k.not(".disabled, .optgroup").last()):(39===b.which||40===b.which)&&(e=n.nextAll(":not('.disabled, .optgroup')").first(),f=k.not(".disabled, .optgroup").first()),!e.hasClass("sod_option")&&m&&(e=f),(e.hasClass("sod_option")||m)&&(n.removeClass("active"),e.addClass("active"),l.get(0).lastChild.nodeValue=e.text(),h.listScroll(j,e),i.hasClass("open")||(g=!0)),!1):(13===b.which||32===b.which&&i.hasClass("open")&&(" "===i.data("filter")[0]||""===i.data("filter"))?(b.preventDefault(),n.click()):32!==b.which||i.hasClass("open")||" "!==i.data("filter")[0]&&""!==i.data("filter")?27===b.which&&h.blurSod(i):(b.preventDefault(),g=!1,i.click()),void(0!==b.which&&(clearTimeout(c),i.data("filter",i.data("filter")+String.fromCharCode(b.which)),d=k.filter(function(){return 0===a(this).text().toLowerCase().indexOf(i.data("filter").toLowerCase())}).not(".disabled, .optgroup").first(),d.length&&(n.removeClass("active"),d.addClass("active"),h.listScroll(j,d),l.get(0).lastChild.nodeValue=d.text(),i.hasClass("open")||(g=!0)),c=setTimeout(function(){i.data("filter","")},500))))},optionHover:function(){var b=a(this);b.hasClass("disabled")||b.hasClass("optgroup")||b.siblings().removeClass("active").end().addClass("active")},optionClick:function(b){b.stopPropagation();var c=a(this),e=c.closest(".sod_select"),f=c.hasClass("disabled"),g=c.hasClass("optgroup"),h=e.find(".sod_option:not('.optgroup')").index(this);e.hasClass("touch")||(f||g||(e.find(".selected, .sod_placeholder").removeClass("selected sod_placeholder"),c.addClass("selected"),e.find("select option")[h].selected=!0,e.find("select").change()),clearTimeout(d),e.removeClass("open"))},selectChange:function(){var b=a(this),c=b.find(":selected"),d=c.text(),e=b.closest(".sod_select"),g=e.find(".sod_label"),h=e.find(".sod_list .sod_option");g.text(d),h.removeClass("selected"),h.each(function(){var c=a(this);c.data("value")===b.val()&&c.addClass("selected")}),e.data("label",d),f.onChange.call(this),!e.data("links")&&!c.data("link")||c.data("link-external")?(e.data("links-external")||c.data("link-external"))&&window.open(c.val(),"_blank"):window.location.href=c.val()},blurSod:function(b){if(a("body").find(b).length){var c=b.data("label"),e=b.data("placeholder"),f=b.find(".active"),h=b.find(".selected"),i=!1;clearTimeout(d),g&&!f.hasClass("selected")?(f.click(),i=!0):f.hasClass("selected")||(f.removeClass("active"),h.addClass("active")),!i&&e?b.find(".sod_label").get(0).lastChild.nodeValue=h.text():i||(b.find(".sod_label").get(0).lastChild.nodeValue=c),g=!1,b.removeClass("open focus"),b.blur(),a("html").off(".sodBlur")}},checkViewport:function(b,c){var e=b[0].getBoundingClientRect(),f=c.outerHeight();e.bottom+f+10>a(window).height()&&e.top-f>10?b.addClass("above"):b.removeClass("above"),d=setTimeout(function(){h.checkViewport(b,c)},200)},listScroll:function(a,b){var c=a[0].getBoundingClientRect(),d=b[0].getBoundingClientRect();c.top>d.top?a.scrollTop(a.scrollTop()-c.top+d.top):c.bottom<d.bottom&&a.scrollTop(a.scrollTop()-c.bottom+d.bottom)},isTouch:function(){return"ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0}},i={destroy:function(){return this.each(function(){var b=a(this),c=b.parent();c.hasClass("sod_select")?(b.off("change"),c.find("span").remove(),b.unwrap()):console.log("Select or Die: There's no SoD to destroy")})},update:function(){return this.each(function(){var b=a(this),c=b.parent(),d=c.find(".sod_list:first");c.hasClass("sod_select")?(d.empty(),c.find(".sod_label").get(0).lastChild.nodeValue="",b.is(":disabled")&&c.addClass("disabled"),a("option, optgroup",b).each(function(){h.populateSoD(a(this),d,c)})):console.log("Select or Die: There's no SoD to update")})},disable:function(b){return this.each(function(){var c=a(this),d=c.parent();d.hasClass("sod_select")?"undefined"!=typeof b?(d.find(".sod_list:first .sod_option[data-value='"+b+"']").addClass("disabled"),d.find(".sod_list:first .sod_option[data-label='"+b+"']").nextUntil(":not(.groupchild)").addClass("disabled"),a("option[value='"+b+"'], optgroup[label='"+b+"']",this).prop("disabled",!0)):d.hasClass("sod_select")&&(d.addClass("disabled"),c.prop("disabled",!0)):console.log("Select or Die: There's no SoD to disable")})},enable:function(b){return this.each(function(){var c=a(this),d=c.parent();d.hasClass("sod_select")?"undefined"!=typeof b?(d.find(".sod_list:first .sod_option[data-value='"+b+"']").removeClass("disabled"),d.find(".sod_list:first .sod_option[data-label='"+b+"']").nextUntil(":not(.groupchild)").removeClass("disabled"),a("option[value='"+b+"'], optgroup[label='"+b+"']",this).prop("disabled",!1)):d.hasClass("sod_select")&&(d.removeClass("disabled"),c.prop("disabled",!1)):console.log("Select or Die: There's no SoD to enable")})}};return i[b]?i[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?void a.error('Select or Die: Oh no! No such method "'+b+'" for the SoD instance'):h.initSoD.apply(this,arguments)}}(jQuery);
