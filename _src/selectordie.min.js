/* ===========================================================
 *
 *  Name:          selectordie.js
 *  Updated:       2014-10-11
 *  Version:       0.1.8
 *  Created by:    Per V @ Vst.mn
 *  What?:         The Select or Die JS
 *
 *  Copyright (c) 2014 Per Vestman
 *  Dual licensed under the MIT and GPL licenses.
 *
 *  To much comments in the code. Please, I know.
 *
 *  Oddny | Cogs 'n Kegs
 *
 *  @preserve
 *
 * =========================================================== */
(function(e){"use strict";e.fn.selectOrDie=function(a){var t={customID:null,customClass:"",placeholder:null,placeholderOption:false,prefix:null,cycle:false,stripEmpty:false,links:false,linksExternal:false,size:0,tabIndex:0,onChange:e.noop},s={},l=false,o,i;var d={initSoD:function(a){s=e.extend({},t,a);return this.each(function(){if(!e(this).parent().hasClass("sod_select")){var a=e(this),t=a.data("custom-id")?a.data("custom-id"):s.customID,l=a.data("custom-class")?a.data("custom-class"):s.customClass,o=a.data("prefix")?a.data("prefix"):s.prefix,i=a.data("placeholder")?a.data("placeholder"):s.placeholder,n=a.data("placeholder-option")?a.data("placeholder-option"):s.placeholderOption,r=a.data("cycle")?a.data("cycle"):s.cycle,c=a.data("links")?a.data("links"):s.links,p=a.data("links-external")?a.data("links-external"):s.linksExternal,f=parseInt(a.data("size"))?a.data("size"):s.size,h=parseInt(a.data("tabindex"))?a.data("tabindex"):s.tabIndex?s.tabIndex:a.attr("tabindex")?a.attr("tabindex"):s.tabIndex,u=a.data("strip-empty")?a.data("strip-empty"):s.stripEmpty,b=a.prop("title")?a.prop("title"):null,C=a.is(":disabled")?" disabled":"",v="",g="",m=0,_,x,k;if(o){v='<span class="sod_prefix">'+o+"</span> "}if(i&&!o){g+='<span class="sod_label sod_placeholder">'+i+"</span>"}else{g+='<span class="sod_label">'+v+"</span>"}_=e("<span/>",{id:t,"class":"sod_select "+l+C,title:b,tabindex:h,html:g,"data-cycle":r,"data-links":c,"data-links-external":p,"data-placeholder":i,"data-placeholder-option":n,"data-prefix":o,"data-filter":""}).insertAfter(this);if(d.isTouch()){_.addClass("touch")}x=e("<span/>",{"class":"sod_list_wrapper"}).appendTo(_);k=e("<span/>",{"class":"sod_list"}).appendTo(x);e("option, optgroup",a).each(function(a){var t=e(this);if(u&&!e.trim(t.text())){t.remove()}else if(a===0&&n&&!v)d.populateSoD(t,k,_,true);else{d.populateSoD(t,k,_,false)}});if(f){x.show();e(".sod_option:lt("+f+")",k).each(function(){m+=e(this).outerHeight()});x.removeAttr("style");k.css({"max-height":m})}a.appendTo(_);_.on("focusin",d.focusSod).on("click",d.triggerSod).on("click",".sod_option",d.optionClick).on("mousemove",".sod_option",d.optionHover).on("keydown",d.keyboardUse);a.on("change",d.selectChange);e(document).on("click","label[for='"+a.attr("id")+"']",function(e){e.preventDefault();_.focus()})}else{console.log("Select or Die: It looks like the SoD already exists")}})},populateSoD:function(a,t,s,l){var o=s.data("placeholder"),i=s.data("placeholder-option"),d=s.data("prefix"),n=s.find(".sod_label"),r=a.parent(),c=a.text(),p=a.val(),f=a.data("custom-id")?a.data("custom-id"):null,h=a.data("custom-class")?a.data("custom-class"):"",u=a.is(":disabled")?" disabled ":"",b=a.is(":selected")?" selected active ":"",C=a.data("link")?" link ":"",v=a.data("link-external")?" linkexternal":"",g=a.prop("label");if(a.is("option")){e("<span/>",{"class":"sod_option "+h+u+b+C+v,id:f,title:c,html:c,"data-value":p}).appendTo(t);if(l&&!d){s.data("label",c);s.data("placeholder",c);a.prop("disabled",true);t.find(".sod_option:last").addClass("is-placeholder disabled");if(b){n.addClass("sod_placeholder")}}else if(b&&o&&!i&&!d){s.data("label",o)}else if(b){s.data("label",c)}if(b&&!o||b&&i||b&&d){n.append(c)}if(r.is("optgroup")){t.find(".sod_option:last").addClass("groupchild");if(r.is(":disabled")){t.find(".sod_option:last").addClass("disabled")}}}else{e("<span/>",{"class":"sod_option optgroup "+u,title:g,html:g,"data-label":g}).appendTo(t)}},focusSod:function(){var a=e(this);if(!a.hasClass("disabled")){d.blurSod(e(".sod_select.focus").not(a));a.addClass("focus");e("html").on("click.sodBlur",function(){d.blurSod(a)})}else{d.blurSod(a)}},triggerSod:function(a){a.stopPropagation();var t=e(this),s=t.find(".sod_list"),l=t.data("placeholder"),o=t.find(".active"),n=t.find(".selected");if(!t.hasClass("disabled")&&!t.hasClass("open")&&!t.hasClass("touch")){t.addClass("open");if(l&&!t.data("prefix")){t.find(".sod_label").addClass("sod_placeholder").html(l)}d.listScroll(s,n);d.checkViewport(t,s)}else{clearTimeout(i);t.removeClass("open");if(l){t.find(".sod_label").get(0).lastChild.nodeValue=o.text()}}},keyboardUse:function(a){var t=e(this),s=t.find(".sod_list"),i=t.find(".sod_option"),n=t.find(".sod_label"),r=t.data("cycle"),c=i.filter(".active"),p,f,h;if(a.which>36&&a.which<41){if(a.which===37||a.which===38){f=c.prevAll(":not('.disabled, .optgroup')").first();h=i.not(".disabled, .optgroup").last()}else if(a.which===39||a.which===40){f=c.nextAll(":not('.disabled, .optgroup')").first();h=i.not(".disabled, .optgroup").first()}if(!f.hasClass("sod_option")&&r){f=h}if(f.hasClass("sod_option")||r){c.removeClass("active");f.addClass("active");n.get(0).lastChild.nodeValue=f.text();d.listScroll(s,f);if(!t.hasClass("open")){l=true}}return false}else if(a.which===13||a.which===32&&t.hasClass("open")&&(t.data("filter")[0]===" "||t.data("filter")==="")){a.preventDefault();c.click()}else if(a.which===32&&!t.hasClass("open")&&(t.data("filter")[0]===" "||t.data("filter")==="")){a.preventDefault();l=false;t.click()}else if(a.which===27){d.blurSod(t)}if(a.which!==0){clearTimeout(o);t.data("filter",t.data("filter")+String.fromCharCode(a.which));p=i.filter(function(){return e(this).text().toLowerCase().indexOf(t.data("filter").toLowerCase())===0}).not(".disabled, .optgroup").first();if(p.length){c.removeClass("active");p.addClass("active");d.listScroll(s,p);n.get(0).lastChild.nodeValue=p.text();if(!t.hasClass("open")){l=true}}o=setTimeout(function(){t.data("filter","")},500)}},optionHover:function(){var a=e(this);if(!a.hasClass("disabled")&&!a.hasClass("optgroup")){a.siblings().removeClass("active").end().addClass("active")}},optionClick:function(a){a.stopPropagation();var t=e(this),s=t.closest(".sod_select"),l=t.hasClass("disabled"),o=t.hasClass("optgroup"),d=s.find(".sod_option:not('.optgroup')").index(this);if(s.hasClass("touch")){return}if(!l&&!o){s.find(".selected, .sod_placeholder").removeClass("selected sod_placeholder");t.addClass("selected");s.find("select option")[d].selected=true;s.find("select").change()}clearTimeout(i);s.removeClass("open")},selectChange:function(){var a=e(this),t=a.find(":selected"),l=t.text(),o=a.closest(".sod_select");o.find(".sod_label").get(0).lastChild.nodeValue=l;o.data("label",l);s.onChange.call(this);if((o.data("links")||t.data("link"))&&!t.data("link-external")){window.location.href=t.val()}else if(o.data("links-external")||t.data("link-external")){window.open(t.val(),"_blank")}},blurSod:function(a){if(e("body").find(a).length){var t=a.data("label"),s=a.data("placeholder"),o=a.find(".active"),d=a.find(".selected"),n=false;clearTimeout(i);if(l&&!o.hasClass("selected")){o.click();n=true}else if(!o.hasClass("selected")){o.removeClass("active");d.addClass("active")}if(!n&&s&&!a.hasClass("touch")){a.find(".sod_label").get(0).lastChild.nodeValue=d.text()}else if(!n){a.find(".sod_label").get(0).lastChild.nodeValue=t}l=false;a.removeClass("open focus");a.blur();e("html").off(".sodBlur")}},checkViewport:function(a,t){var s=a[0].getBoundingClientRect(),l=t.outerHeight();if(s.bottom+l+10>e(window).height()&&s.top-l>10){a.addClass("above")}else{a.removeClass("above")}i=setTimeout(function(){d.checkViewport(a,t)},200)},listScroll:function(e,a){var t=e[0].getBoundingClientRect(),s=a[0].getBoundingClientRect();if(t.top>s.top){e.scrollTop(e.scrollTop()-t.top+s.top)}else if(t.bottom<s.bottom){e.scrollTop(e.scrollTop()-t.bottom+s.bottom)}},isTouch:function(){return"ontouchstart"in window||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0}};var n={destroy:function(){return this.each(function(){var a=e(this),t=a.parent();if(t.hasClass("sod_select")){a.off("change");t.find("span").remove();a.unwrap()}else{console.log("Select or Die: There's no SoD to destroy")}})},update:function(){return this.each(function(){var a=e(this),t=a.parent(),s=t.find(".sod_list:first");if(t.hasClass("sod_select")){s.empty();t.find(".sod_label").get(0).lastChild.nodeValue="";if(a.is(":disabled")){t.addClass("disabled")}e("option, optgroup",a).each(function(){d.populateSoD(e(this),s,t)})}else{console.log("Select or Die: There's no SoD to update")}})},disable:function(a){return this.each(function(){var t=e(this),s=t.parent();if(s.hasClass("sod_select")){if(typeof a!=="undefined"){s.find(".sod_list:first .sod_option[data-value='"+a+"']").addClass("disabled");s.find(".sod_list:first .sod_option[data-label='"+a+"']").nextUntil(":not(.groupchild)").addClass("disabled");e("option[value='"+a+"'], optgroup[label='"+a+"']",this).prop("disabled",true)}else if(s.hasClass("sod_select")){s.addClass("disabled");t.prop("disabled",true)}}else{console.log("Select or Die: There's no SoD to disable")}})},enable:function(a){return this.each(function(){var t=e(this),s=t.parent();if(s.hasClass("sod_select")){if(typeof a!=="undefined"){s.find(".sod_list:first .sod_option[data-value='"+a+"']").removeClass("disabled");s.find(".sod_list:first .sod_option[data-label='"+a+"']").nextUntil(":not(.groupchild)").removeClass("disabled");e("option[value='"+a+"'], optgroup[label='"+a+"']",this).prop("disabled",false)}else if(s.hasClass("sod_select")){s.removeClass("disabled");t.prop("disabled",false)}}else{console.log("Select or Die: There's no SoD to enable")}})}};if(n[a]){return n[a].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof a==="object"||!a){return d.initSoD.apply(this,arguments)}else{e.error('Select or Die: Oh no! No such method "'+a+'" for the SoD instance')}}})(jQuery);